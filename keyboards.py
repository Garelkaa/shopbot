from aiogram.types import \
    ReplyKeyboardMarkup, KeyboardButton, \
    InlineKeyboardMarkup, InlineKeyboardButton

from models import Promocode, City, Area, Position, Good, paySystem
from utils.config import config
from utils.utils import Access


def main_keyboard() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup()
    kb.row(KeyboardButton("üè† –ì–æ—Ä–æ–¥–∞"), KeyboardButton("üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞"))
    kb.row(KeyboardButton("üë§ –í–∞–∫–∞–Ω—Å–∏–∏"), KeyboardButton("üõí –ü—Ä–µ–¥–∑–∞–∫–∞–∑"))
    kb.row(KeyboardButton("üíæ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤"), KeyboardButton("üìñ –û—Ç–∑—ã–≤—ã | –ì–∞—Ä–∞–Ω—Ç–∏–∏"))
    kb.row(KeyboardButton("üìö –ü—Ä–∞–≤–∏–ª–∞"), KeyboardButton("üó£Ô∏è –ß–∞—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤"))
    return kb


def worker_keyboard() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', callback_data='stats_menu'))
    kb.add(InlineKeyboardButton('üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã', callback_data='promos_menu'))
    return kb


def admin_keyboard() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup()
    kb.row(KeyboardButton('üè† –ì–æ—Ä–æ–¥–∞'), KeyboardButton('üì¶ –¢–æ–≤–∞—Ä—ã'))
    kb.row(KeyboardButton('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'), KeyboardButton('üë∑ –í–æ—Ä–∫–µ—Ä—ã'))
    # kb.row(KeyboardButton('üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã'), KeyboardButton('üìã –¢–µ–∫—Å—Ç –æ–ø–ª–∞—Ç—ã'))
    kb.row(KeyboardButton('üìã –¢–µ–∫—Å—Ç –æ–ø–ª–∞—Ç—ã'), KeyboardButton('üîó –°—Å—ã–ª–∫–∏'))
    return kb


def single_url_inline(text) -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton(text, url='http://t.me/' + config.links.admin_username))
    return kb


def support_inline() -> InlineKeyboardMarkup:
    return single_url_inline('üë®‚Äçüíª –ù–∞–ø–∏—Å–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É')


def vacancies_inline() -> InlineKeyboardMarkup:
    return single_url_inline('üí∞ –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—Ç—É üí∞')


def preorder_inline() -> InlineKeyboardMarkup:
    return single_url_inline('üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É')


def reviews_inline() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton('üìö –ü—Ä–∞–≤–∏–ª–∞', callback_data='review'))
    kb.add(InlineKeyboardButton('üìç –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª üìç', url=config.links.reviews_channel_url))
    return kb


async def generate_cities_inline(user, access) -> InlineKeyboardMarkup:
    cities = City.filter(hidden=0).order_by('name') if access == Access.USER else City.all().order_by('name')
    promocode = await Promocode.get_or_none(id=user.promocode)
    cities_id = [int(x) for x in promocode.cities.strip('|').split('|')] if promocode and promocode.cities else None
    keyboard = InlineKeyboardMarkup()
    async for city in cities:
        if cities_id and city.id not in cities_id:
            continue
        keyboard.add(InlineKeyboardButton('{}üè° {}'.format('üö´' if city.hidden else '', city.name),
                                          callback_data='city_{}'.format(city.id)))
    if access == Access.ADMIN:
        keyboard.add(InlineKeyboardButton('‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥', callback_data='add_city'))
    return keyboard


async def generate_areas_inline(city, access) -> InlineKeyboardMarkup:
    areas = Area.filter(hidden=0, city=city).order_by('name') if access == Access.USER else Area.filter(city=city).order_by('name')
    city = await City.get(id=int(city))
    keyboard = InlineKeyboardMarkup()
    async for area in areas:
        keyboard.add(InlineKeyboardButton('{}üìÇ {}'.format('üö´' if area.hidden else '', area.name),
                                          callback_data='area_{}'.format(area.id)))
    if access == Access.ADMIN:
        keyboard.add(InlineKeyboardButton('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥', callback_data='remove_city_{}'.format(city.id)))
        if not city.hidden:
            keyboard.add(InlineKeyboardButton('üö´ –°–∫—Ä—ã—Ç—å –≥–æ—Ä–æ–¥', callback_data='hide_city_{}'.format(city.id)))
        else:
            keyboard.add(InlineKeyboardButton('‚ûï –†–∞—Å–∫—Ä—ã—Ç—å –≥–æ—Ä–æ–¥', callback_data='unhide_city_{}'.format(city.id)))
        keyboard.add(InlineKeyboardButton('‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–π–æ–Ω', callback_data='add_area_{}'.format(city.id)))
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='cities'))
    return keyboard


def worker_stats_inline():
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='worker_menu'))
    return keyboard


async def generate_goods_inline(area_id, access) -> InlineKeyboardMarkup:
    # positions = Position.filter(area=area, hidden=0) if access == Access.USER else Position.filter(area=area)
    # goods = list()
    # async for position in positions:
    #     good = await position.good.first()
    #     if good not in goods:
    #         if access == Access.ADMIN or not good.hidden:
    #             goods.append(good)
    if access == Access.USER:
        good_ids = [x['good__id'] for x in await Position.filter(area=area_id, hidden=0).distinct().values('good__id')]
        goods = await Good.filter(id__in=good_ids, hidden=0).order_by('name')
    else:
        good_ids = [x['good__id'] for x in await Position.filter(area=area_id).distinct().values('good__id')]
        goods = await Good.filter(id__in=good_ids).order_by('name')
    keyboard = InlineKeyboardMarkup()
    for good in goods:
        keyboard.add(InlineKeyboardButton('{}üì¶ {}'.format('üö´' if good.hidden else '', good.name),
                                          callback_data='good_{}_{}'.format(good.id, area_id)))
    area_id = await Area.get(id=area_id)
    if access == Access.ADMIN:
        keyboard.add(InlineKeyboardButton('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ä–∞–π–æ–Ω', callback_data='remove_area_{}'.format(area_id.id)))
        if not area_id.hidden:
            keyboard.add(InlineKeyboardButton('üö´ –°–∫—Ä—ã—Ç—å —Ä–∞–π–æ–Ω', callback_data='hide_area_{}'.format(area_id.id)))
        else:
            keyboard.add(InlineKeyboardButton('‚ûï –†–∞—Å–∫—Ä—ã—Ç—å —Ä–∞–π–æ–Ω', callback_data='unhide_area_{}'.format(area_id.id)))
        keyboard.add(InlineKeyboardButton('‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é', callback_data='add_position_{}'.format(area_id.id)))
    city = await area_id.city.first()
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='city_{}'.format(city.id)))
    return keyboard


async def generate_goods_admin_inline() -> InlineKeyboardMarkup:  # Goods menu for admin
    goods = Good.all().order_by('name')
    keyboard = InlineKeyboardMarkup()
    async for good in goods:
        keyboard.add(InlineKeyboardButton('{}üì¶ {}'.format('üö´' if good.hidden else '', good.name),
                                          callback_data='show_good_{}'.format(good.id)))
    keyboard.add(InlineKeyboardButton('‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä', callback_data='add_good'))
    return keyboard


async def generate_good_edit_inline(good_id) -> InlineKeyboardMarkup:
    good = await Good.get(id=good_id)
    keyboard = InlineKeyboardMarkup()
    if good.hidden:
        keyboard.add(InlineKeyboardButton('‚ûï –†–∞—Å–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä', callback_data='unhide_good_{}'.format(good.id)))
    else:
        keyboard.add(InlineKeyboardButton('üö´ –°–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä', callback_data='hide_good_{}'.format(good.id)))
    keyboard.add(InlineKeyboardButton('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', callback_data='remove_good_{}'.format(good.id)))
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='goods_menu'))
    return keyboard


async def generate_positions_inline(good: Good, area: int, access: Access) -> InlineKeyboardMarkup:
    if access is Access.USER:
        positions = Position.filter(good=good, area=area, hidden=0).order_by('weight')
    else:
        positions = Position.filter(good=good, area=area).order_by('weight')
    keyboard = InlineKeyboardMarkup()
    async for position in positions:
        keyboard.add(InlineKeyboardButton('{}üîç {} | {} | {} —Ä—É–±'.format('üö´' if position.hidden else '',
                                                                         position.weight,
                                                                         position.type,
                                                                         position.price),
                                          callback_data='position_{}'.format(position.id)))
    # if access == Access.admin:
    #     keyboard.append([Button.inline('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —Ç–æ–≤–∞—Ä –≤ —Ä–∞–π–æ–Ω–µ', callback_data='remove_good_{}_{}'.format(area, good))])
    #     if not area.hidden:
    #         keyboard.append([Button.inline('üö´ –°–∫—Ä—ã—Ç—å –≤–µ—Å—å —Ç–æ–≤–∞—Ä –≤ —Ä–∞–π–æ–Ω–µ', callback_data='hide_good_{}_{}'.format(area, good))])
    #     else:
    #         keyboard.append([Button.inline('‚ûï –†–∞—Å–∫—Ä—ã—Ç—å –≤–µ—Å—å —Ç–æ–≤–∞—Ä –≤ —Ä–∞–π–æ–Ω–µ', callback_data='unhide_good_{}_{}'.format(area, good))])
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='area_{}'.format(area)))
    return keyboard


async def confirmation_zalet_inline(zalet_id: int) -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ª—ë—Ç', callback_data='accept_zalet_{}'.format(zalet_id)))
    keyboard.add(InlineKeyboardButton('‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ª—ë—Ç', callback_data='decline_zalet_{}'.format(zalet_id)))
    return keyboard


async def generate_promo_inline(position, user, access=None) -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    position_object = await Position.get_or_none(id=position)
    if not position_object:
        return
    good = await position_object.good.first()
    area = position_object.area
    # TODO –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
    if access == Access.USER:
        promocode = None
        if user.promocode:
            promocode = await Promocode.get_or_none(id=user.promocode)
        if promocode:
            keyboard.add(InlineKeyboardButton('üéüÔ∏è {} | –°–∫–∏–¥–∫–∞ {}%'.format(promocode.code, promocode.discount),
                                              callback_data='pay_{}_discount_{}'.format(position, promocode.discount)))
        else:
            keyboard.add(InlineKeyboardButton('‚ùå –ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞', callback_data='pay_{}'.format(position)))
    elif access == Access.ADMIN:
        keyboard.add(InlineKeyboardButton('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é', callback_data='remove_position_{}'.format(position)))
        if not position_object.hidden:
            keyboard.add(InlineKeyboardButton('üö´ –°–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é', callback_data='hide_position_{}'.format(position)))
        else:
            keyboard.add(
                InlineKeyboardButton('‚ûï –†–∞—Å–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é', callback_data='unhide_position_{}'.format(position)))
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='good_{}_{}'.format(good.id, area)))
    return keyboard


async def admin_stats_inline() -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    keyboard.add(
        InlineKeyboardButton('‚ùå –£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —é–∑–µ—Ä–æ–≤', callback_data='clear_users')
    )
    return keyboard


async def generate_payout_inline() -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    methods = await paySystem.all()  # –ß–æ —ç—Ç–æ –∑–∞ –º–µ—Ç–æ–¥?
    keyboard.add(
        InlineKeyboardButton('üë®‚Äçüíª –ù–∞–ø–∏—Å–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É', url='https://t.me/{}'.format(config.links.support_username)))
    return keyboard


async def generate_worker_promos_inline(worker) -> InlineKeyboardMarkup:
    promos = Promocode.filter(workerid=worker)
    keyboard = InlineKeyboardMarkup()
    async for promocode in promos:
        keyboard.add(InlineKeyboardButton('üéüÔ∏è {}% {} '.format(promocode.discount, promocode.code),
                                          callback_data='edit_promo_{}'.format(promocode.id)))
    keyboard.add(InlineKeyboardButton('‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', callback_data='generate_promo'))
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='worker_menu'))
    return keyboard


async def generate_promo_edit_inline(promocode_id) -> InlineKeyboardMarkup:
    promocode = await Promocode.get(id=promocode_id)
    keyboard = InlineKeyboardMarkup()
    discount = list()
    discount.append(InlineKeyboardButton('3%', callback_data='set_promo_discount_{}_{}'.format(promocode.id, 3)))
    discount.append(InlineKeyboardButton('5%', callback_data='set_promo_discount_{}_{}'.format(promocode.id, 5)))
    discount.append(InlineKeyboardButton('10%', callback_data='set_promo_discount_{}_{}'.format(promocode.id, 10)))
    discount.append(InlineKeyboardButton('15%', callback_data='set_promo_discount_{}_{}'.format(promocode.id, 15)))
    discount.append(InlineKeyboardButton('20%', callback_data='set_promo_discount_{}_{}'.format(promocode.id, 20)))
    keyboard.add(*discount)
    keyboard.add(InlineKeyboardButton('–í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥–∞ –¥–ª—è –ø—Ä–æ–º–æ',
                                      callback_data='choose_cities_promo_{}'.format(promocode.id)))
    keyboard.add(InlineKeyboardButton('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ', callback_data='remove_promo_{}'.format(promocode.id)))
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='promos_menu'))
    return keyboard


async def generate_promo_cities_inline(promocode_id) -> InlineKeyboardMarkup:
    promocode = await Promocode.get(id=promocode_id)
    cities_id = [int(x) for x in promocode.cities.strip('|').split('|')] if promocode.cities else None
    if cities_id:
        all_cities = False
    else:
        all_cities = True
    cities_obj = City.all()
    keyboard = InlineKeyboardMarkup()
    async for city in cities_obj:
        keyboard.add(InlineKeyboardButton('{}üè° {}'.format('üö´' if not all_cities and city.id not in cities_id else '',
                                                           city.name),
                                          callback_data='promo_{}_city_{}_{}'.format(
                                              'remove' if not all_cities and city.id in cities_id else 'add',
                                              promocode_id, city.id)))
    keyboard.add(InlineKeyboardButton('üîô –ù–∞–∑–∞–¥', callback_data='edit_promo_{}'.format(promocode_id)))
    return keyboard


async def generate_workers_list_inline(page, total) -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    if page > 1:
        keyboard.insert(InlineKeyboardButton('<', callback_data=f'workers_list_{page-1}'))
    keyboard.insert(InlineKeyboardButton(f'{page}/{total}', callback_data=f'workers_list_{page}'))
    if page < total:
        keyboard.insert(InlineKeyboardButton('>', callback_data=f'workers_list_{page+1}'))
    return keyboard


async def generate_links_menu_inline() -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å —é–∑–µ—Ä–Ω–µ–π–º –∞–¥–º–∏–Ω–∞', callback_data='link_change_admin_username'))
    keyboard.add(InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å —é–∑–µ—Ä–Ω–µ–π–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', callback_data='link_change_operator_username'))
    keyboard.add(InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å ID –æ—Ç—Å—Ç—É–∫–∞', callback_data='link_change_forward_channel_id'))
    keyboard.add(InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å ID –∑–∞–ª—ë—Ç–æ–≤', callback_data='link_change_zalets_channel_id'))
    keyboard.add(InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç–∑—ã–≤—ã', callback_data='link_change_reviews_channel_url'))
    return keyboard

async def generate_stats_worker_inline() -> InlineKeyboardMarkup:
    pass

async def method_pay_inline()  -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç', callback_data='change_method_text'))
    return keyboard

@property
def back_button():
    kb = ReplyKeyboardMarkup()
    kb.row(KeyboardButton('üîô –ù–∞–∑–∞–¥'))
    return kb


# –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
async def generate_order_inline(user) -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É ‚úÖ', callback_data='checkorder_{}'.format(user.id)))
    keyboard.add(InlineKeyboardButton('üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞', url='https://t.me/{}'.format(config.links.admin_username)))


def get_kb(key: str) -> InlineKeyboardMarkup:
    kbs = {
        'startreply': main_keyboard,
        'startinline': reviews_inline,
        'support': support_inline,
        'vacancies': vacancies_inline,
        'preorder': preorder_inline,
        'reviews': reviews_inline,
    }
    kb = kbs.get(key, None)
    if kb:
        return kb()
    else:
        return None
